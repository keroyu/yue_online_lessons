# Feature Specification: 上課頁面與管理員後臺

**Feature Branch**: `002-classroom-admin`
**Created**: 2026-01-17
**Status**: Draft
**Input**: User description: "上課頁面（Teachable 風格左欄章節列表 + 右欄影片播放）、管理員後臺（課程管理、章節編輯、相簿管理）"
**Updated**: 2026-01-17 - 新增優惠價/原價定價模式、倒數計時、同頁插入圖片功能、法律政策頁面（Modal）
**Updated**: 2026-01-18 - 新增課程完成狀態節流機制（5分鐘延遲寫入）
**Updated**: 2026-01-30 - 將課程完成狀態節流門檻從 5 分鐘調整為 2 分鐘
**Updated**: 2026-01-30 - 優化優惠倒數計時 UI（卡片式設計 + 數字滾動動畫）
**Updated**: 2026-01-26 - 新增課程建立時自動指派擁有權給管理員、管理員前端預覽所有課程（含草稿）
**Updated**: 2026-01-30 - 新增課程「是否顯示」設定功能（隱藏課程可透過直接連結購買）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 會員上課頁面 (Priority: P1)

已購買課程的會員從「我的課程」頁面點擊課程，進入上課介面 (/member/classroom/{courseId})。頁面採用 Teachable 風格：左欄顯示課程章節列表（章名、節名、時間長度），右欄顯示影片播放器。會員點擊章節列表中的小節，右側切換對應影片。已觀看完成的小節在左欄以綠色勾勾圖示標記。

**Why this priority**: 上課頁面是會員購買課程後的核心使用場景，直接影響學習體驗和課程價值傳遞。

**Independent Test**: 使用已購買課程的測試帳號登入，進入上課頁面，可切換章節觀看影片，並驗證觀看完成標記功能。

**Acceptance Scenarios**:

1. **Given** 會員已購買某課程並登入, **When** 從「我的課程」點擊該課程, **Then** 進入上課頁面 (/member/classroom/{courseId})，顯示章節列表和影片播放器
2. **Given** 會員在上課頁面, **When** 點擊左欄任一小節, **Then** 右側影片播放器切換為該小節的影片內容
3. **Given** 會員重新進入上課頁面, **When** 頁面載入完成, **Then** 之前已完成的小節仍顯示綠色勾勾
4. **Given** 會員在章節列表看到已完成的小節, **When** 點擊該小節的綠色勾勾圖示, **Then** 該小節恢復為未完成狀態（播放圖示）
5. **Given** 會員使用手機瀏覽, **When** 進入上課頁面, **Then** 左欄章節列表可折疊，影片全寬顯示，整體布局適配手機螢幕
6. **Given** 課程小節無影片但有 HTML 內容, **When** 會員點擊該小節, **Then** 右側顯示該小節的 HTML 內容（電子書或文章形式）

---

### User Story 1a - 課程完成狀態節流機制 (Priority: P1)

為避免會員頻繁點選章節時產生過多伺服器請求，系統採用前端節流機制。會員點擊小節後，前端立即顯示綠色勾勾（樂觀更新），但實際完成紀錄需等待該小節停留滿 2 分鐘後才會寫入伺服器。若會員在 2 分鐘內切換到其他小節，則原小節不記錄完成。此機制確保只有真正閱讀/觀看過內容的小節才會被標記為完成。

**Why this priority**: 節流機制直接影響伺服器負載和學習進度的準確性，與上課頁面核心功能緊密相關。

**Independent Test**: 使用測試帳號進入上課頁面，快速切換多個小節（少於2分鐘），驗證這些小節不會被記錄為完成；停留在某小節超過2分鐘後，驗證該小節被記錄為完成。

**Acceptance Scenarios**:

1. **Given** 會員在上課頁面點擊某小節, **When** 該小節內容顯示於右側, **Then** 該小節在左欄立即顯示綠色勾勾（前端樂觀更新）
2. **Given** 會員點擊小節 A 後停留, **When** 停留時間達到 2 分鐘, **Then** 系統自動將小節 A 的完成紀錄寫入伺服器
3. **Given** 會員點擊小節 A 後 1 分鐘內, **When** 切換至小節 B, **Then** 小節 A 的完成紀錄不會寫入伺服器（計時器取消）
4. **Given** 會員快速連續點擊多個小節（每個停留少於2分鐘）, **When** 刷新頁面, **Then** 這些小節仍顯示為未完成（因未達2分鐘門檻）
5. **Given** 會員在小節 A 停留超過 2 分鐘後完成紀錄已寫入, **When** 會員離開頁面後重新進入, **Then** 小節 A 仍顯示為已完成
6. **Given** 會員在小節 A 停留 1 分 50 秒後, **When** 關閉瀏覽器視窗或離開頁面, **Then** 小節 A 不會被記錄為完成
7. **Given** 會員點擊已完成的小節勾勾圖示（取消完成）, **When** 該操作執行, **Then** 取消完成的請求立即發送至伺服器（不受2分鐘限制）

---

### User Story 2 - 管理員課程管理 (Priority: P1)

管理員登入後臺 (/admin)，可查看所有課程列表，新增、編輯和刪除課程。新增課程時輸入課程名稱、教師名稱、時間總長、課程定價（優惠價與原價）。課程狀態分為「草稿」、「預購中」、「熱賣中」。設定為「預購中」的課程可設定正式開賣時間，時間到自動切換為「熱賣中」。

**Why this priority**: 課程管理是後臺的基礎功能，沒有課程資料就無法進行後續的章節編輯和上架。

**Independent Test**: 使用管理員帳號登入後臺，可完整執行課程的 CRUD 操作，並驗證狀態切換邏輯。

**Acceptance Scenarios**:

1. **Given** 管理員已登入後臺, **When** 進入課程管理頁面, **Then** 顯示所有課程列表，包含名稱、教師、狀態、優惠價、原價
2. **Given** 管理員在課程管理頁面, **When** 點擊「新增課程」並填寫必要欄位後儲存, **Then** 課程建立成功，預設狀態為「草稿」
3. **Given** 管理員編輯某課程, **When** 將狀態改為「預購中」並設定開賣時間, **Then** 儲存成功，該課程在首頁顯示為「預購中」
4. **Given** 課程設定為「預購中」且已到開賣時間, **When** 系統檢查狀態（每分鐘或即時）, **Then** 課程狀態自動切換為「熱賣中」
5. **Given** 管理員要刪除某課程, **When** 點擊刪除並確認, **Then** 課程被軟刪除（或提示無法刪除若有購買紀錄）
6. **Given** 管理員編輯課程定價, **When** 設定優惠價、原價和優惠到期時間, **Then** 儲存成功，課程以優惠價展示直到到期
7. **Given** 管理員僅填寫優惠價欄位, **When** 不設定原價和到期時間, **Then** 課程僅顯示優惠價（無倒數計時、無原價刪除線）

---

### User Story 2a - 課程販售頁優惠倒數計時 (Priority: P1)

會員在課程販售頁面查看課程時，若該課程設有優惠價且優惠尚未到期，頁面在講師名稱和時間長度的右側顯示醒目的價格區塊：原價（刪除線樣式）和優惠價（醒目大字），以及倒數計時器。倒數計時器每秒即時更新，顯示「優惠剩餘 X 天 HH:MM:SS」格式。優惠到期後，頁面切換為僅顯示原價（無刪除線），優惠價和倒數計時消失。

**Why this priority**: 優惠倒數計時是促銷轉換的重要工具，與課程管理緊密相關。

**Independent Test**: 設定一個有優惠價的課程，前台查看倒數計時是否正確顯示並即時更新。

**Acceptance Scenarios**:

1. **Given** 課程設有優惠價、原價和到期時間（優惠期間）, **When** 會員查看課程販售頁, **Then** 顯示原價（刪除線）+ 優惠價（醒目大字）+ 倒數計時
2. **Given** 課程優惠倒數計時顯示中, **When** 時間流逝, **Then** 倒數計時器即時更新（每秒）
3. **Given** 課程優惠時間已到期, **When** 會員查看課程販售頁, **Then** 僅顯示原價（無刪除線），優惠價和倒數計時隱藏
4. **Given** 課程僅設定優惠價（無原價、無到期時間）, **When** 會員查看課程販售頁, **Then** 僅顯示優惠價（無刪除線、無倒數計時）
5. **Given** 會員正在查看課程頁面且倒數計時歸零, **When** 優惠到期, **Then** 頁面動態切換為僅顯示原價（無刪除線）

---

### User Story 2b - 優惠倒數計時 UI 優化 (Priority: P2)

現有倒數計時器採用簡單文字顯示，視覺吸引力不足。優化為現代化卡片式設計：深色背景區塊，標題「優惠倒數」，每個時間單位（天、時、分、秒）獨立顯示在圓角卡片內，數字切換時有向下滾動的動畫效果，營造緊迫感並提升購買轉換率。

**Why this priority**: 優化現有功能的視覺呈現，不影響核心功能，但能顯著提升用戶體驗和轉換率。

**Independent Test**: 設定一個有優惠價的課程，前台查看倒數計時是否以新的卡片式設計顯示，並驗證數字滾動動畫效果。

**Acceptance Scenarios**:

1. **Given** 課程有優惠倒數計時, **When** 會員查看課程販售頁, **Then** 倒數計時器以深色背景卡片式設計顯示
2. **Given** 倒數計時器顯示中, **When** 觀察時間單位, **Then** 每個數值（天、時、分、秒）獨立顯示在圓角卡片內
3. **Given** 倒數計時器顯示中, **When** 秒數變化時, **Then** 數字以向下滾動動畫切換（非直接替換）
4. **Given** 倒數計時器顯示中, **When** 分鐘/小時/天數變化時, **Then** 對應數字同樣以滾動動畫切換
5. **Given** 會員使用手機瀏覽, **When** 查看倒數計時器, **Then** 卡片式設計適配手機螢幕，保持可讀性
6. **Given** 優惠時間已到期, **When** 倒數歸零, **Then** 整個倒數計時區塊隱藏，僅顯示原價

---

### User Story 3 - 管理員課程章節編輯 (Priority: P1)

管理員進入某課程的章節編輯頁面，可新增「章」和「節」。「章」用於劃分大單元，「節」為實際課程內容。新增小節時可輸入節名稱、選填 Vimeo/YouTube 影片連結，或插入自定義 HTML 內容。完成編輯後可將課程從「草稿」發佈。

**Why this priority**: 章節是課程的核心結構，必須能編輯章節才能讓會員上課。

**Independent Test**: 管理員可為課程新增章節、設定影片連結或 HTML 內容，並將課程發佈。

**Acceptance Scenarios**:

1. **Given** 管理員在課程編輯頁面, **When** 點擊「新增章」並輸入章名稱, **Then** 章節列表新增一個章，顯示章標題
2. **Given** 管理員已有章存在, **When** 在該章下點擊「新增節」並輸入節名稱, **Then** 該章下新增一個小節
3. **Given** 管理員也可以不建章, **When** 直接點擊「新增節」, **Then** 小節建立在無章分類下（獨立小節）
4. **Given** 管理員編輯某小節, **When** 輸入 Vimeo 連結（如 https://vimeo.com/1032766965）, **Then** 系統解析並儲存影片資訊
5. **Given** 管理員編輯某小節, **When** 輸入 YouTube 連結, **Then** 系統解析並儲存影片資訊
6. **Given** 某小節不需要影片, **When** 管理員在內容區輸入自定義 HTML, **Then** 儲存成功，該小節顯示為文字/圖文內容
7. **Given** 課程狀態為「草稿」且管理員完成編輯, **When** 點擊「發佈課程」, **Then** 系統自動判斷狀態（有設定未來開賣時間 → 預購中，否則 → 熱賣中）
8. **Given** 課程已發佈（預購中/熱賣中）且管理員編輯內容, **When** 點擊「儲存」, **Then** 內容更新但狀態不變
9. **Given** 課程已發佈（預購中/熱賣中）, **When** 管理員點擊「下架為草稿」, **Then** 課程狀態變回「草稿」，前台不可見
10. **Given** 管理員要調整章節順序, **When** 拖曳章或節, **Then** 順序更新成功

---

### User Story 4 - 管理員課程介紹頁編輯與同頁插圖 (Priority: P2)

管理員可編輯課程的介紹頁內容，支援插入自定義 HTML。在編輯介紹頁時，可直接點擊「插入圖片」按鈕，在同一頁面彈出相簿 Modal，瀏覽並選擇圖片、設定長寬後插入。相簿 Modal 內也可直接上傳新圖片，上傳完成後可立即選取插入。

**Why this priority**: 介紹頁影響課程銷售轉換，同頁插圖功能大幅提升編輯效率。

**Independent Test**: 管理員可在同一頁面完成編輯、打開相簿、上傳圖片、設定尺寸、插入圖片的完整流程。

**Acceptance Scenarios**:

1. **Given** 管理員在課程介紹編輯頁, **When** 在編輯器中輸入 HTML 內容, **Then** 儲存成功，課程販售頁顯示該 HTML 內容
2. **Given** 管理員在課程介紹編輯頁, **When** 點擊「插入圖片」按鈕, **Then** 彈出相簿 Modal（不離開當前頁面），顯示該課程所有圖片縮圖
3. **Given** 相簿 Modal 已開啟, **When** 管理員點擊某圖片縮圖, **Then** 該圖片被選中，顯示尺寸設定表單（寬度、高度輸入框）
4. **Given** 管理員選擇圖片並設定尺寸, **When** 點擊「插入」按鈕, **Then** 對應 HTML img 標籤插入編輯器游標位置，Modal 關閉
5. **Given** 相簿 Modal 已開啟, **When** 管理員點擊「上傳圖片」並選擇檔案, **Then** 圖片上傳完成後出現在相簿縮圖列表中
6. **Given** 相簿 Modal 已開啟, **When** 管理員點擊某圖片的刪除按鈕, **Then** 確認後圖片從相簿移除
7. **Given** 管理員設定圖片尺寸, **When** 僅填寫寬度, **Then** 高度自動按比例計算（或留空讓瀏覽器自適應）
8. **Given** 管理員設定圖片尺寸, **When** 僅填寫高度, **Then** 寬度自動按比例計算（或留空讓瀏覽器自適應）

---

### User Story 5 - 管理員後臺權限控管 (Priority: P2)

只有角色為 admin 的用戶可進入後臺 (/admin)。一般會員或未登入用戶嘗試進入後臺時，跳轉至首頁或顯示無權限訊息。

**Why this priority**: 權限控管是後臺安全的基礎，但可在功能開發時一併處理。

**Independent Test**: 使用不同角色帳號測試後臺存取權限。

**Acceptance Scenarios**:

1. **Given** 管理員（role=admin）已登入, **When** 訪問 /admin, **Then** 顯示後臺首頁
2. **Given** 一般會員（role=member）已登入, **When** 訪問 /admin, **Then** 跳轉至首頁並顯示無權限訊息
3. **Given** 用戶未登入, **When** 訪問 /admin, **Then** 跳轉至登入頁面

---

### User Story 6 - 法律政策頁面 Modal (Priority: P2)

網站提供「服務條款」「購買須知」「隱私政策」三個法律政策頁面。用戶點擊頁尾或相關連結時，以 Modal 形式在當前頁面彈出顯示，無需導航至新頁面。購買須知包含退款政策：「迷你課」和「講座」恕不退款；大型課的退款申請需在購買後 14 日內提出，且課程完成度不得超過 20%。

**Why this priority**: 法律政策是網站營運的必要元素，保護平台與用戶權益，但不影響核心功能。

**Independent Test**: 點擊頁尾的政策連結，驗證 Modal 正確顯示對應內容並可關閉。

**Acceptance Scenarios**:

1. **Given** 用戶在任意頁面, **When** 點擊頁尾「服務條款」連結, **Then** 彈出 Modal 顯示服務條款內容，背景頁面不變
2. **Given** 用戶在任意頁面, **When** 點擊頁尾「購買須知」連結, **Then** 彈出 Modal 顯示購買須知內容，包含完整退款政策
3. **Given** 用戶在任意頁面, **When** 點擊頁尾「隱私政策」連結, **Then** 彈出 Modal 顯示隱私政策內容
4. **Given** 法律政策 Modal 已開啟, **When** 用戶點擊關閉按鈕或 Modal 外區域, **Then** Modal 關閉，返回原頁面
5. **Given** 用戶在課程販售頁, **When** 點擊「購買須知」連結, **Then** 彈出購買須知 Modal，用戶可閱讀退款政策
6. **Given** 用戶使用手機瀏覽, **When** 開啟法律政策 Modal, **Then** Modal 適配手機螢幕，內容可滾動閱讀
7. **Given** 購買須知 Modal 已開啟, **When** 用戶閱讀退款政策, **Then** 可看到「迷你課和講座恕不退款」及「大型課 14 日內、完成度 20% 以下可申請退款」說明

---

### User Story 7 - 課程建立時自動指派擁有權給管理員 (Priority: P1)

管理員在後台新增課程時，系統自動為該管理員建立課程購買紀錄，讓管理員立即擁有該課程的存取權限。這確保管理員可在前端以會員身份瀏覽和測試課程內容，無需手動建立購買紀錄。

**Why this priority**: 此功能是管理員前端預覽流程的必要前提，確保管理員能夠存取自己建立的課程。

**Independent Test**: 管理員新增課程後，從「我的課程」頁面可看到該課程，可進入上課頁面。

**Acceptance Scenarios**:

1. **Given** 管理員在後台新增課程, **When** 課程建立成功, **Then** 系統自動為該管理員建立購買紀錄
2. **Given** 管理員已建立某課程, **When** 管理員前往「我的課程」頁面, **Then** 可在列表中看到該課程
3. **Given** 管理員已建立某課程（含草稿狀態）, **When** 管理員點擊該課程, **Then** 可進入上課頁面瀏覽內容
4. **Given** 課程由管理員 A 建立, **When** 管理員 B 查看「我的課程」, **Then** 管理員 B 看不到該課程（除非另行購買或指派）
5. **Given** 管理員自動獲得的購買紀錄, **When** 查看訂單紀錄, **Then** 顯示為「系統指派」類型，金額為 $0

---

### User Story 8 - 管理員前端預覽所有課程（含草稿） (Priority: P1)

管理員登入後，在首頁和課程販售頁可以看到所有課程，包括「草稿」狀態的課程。這讓管理員可以在正式上架前，以用戶視角在前端完整檢查課程內容、排版和購買流程，確保課程品質後再發佈。

**Why this priority**: 此功能直接支援課程品質控管流程，讓管理員能夠在正式上架前發現並修正問題。

**Independent Test**: 管理員登入後瀏覽首頁，可看到草稿課程（一般會員看不到）；點擊草稿課程可進入販售頁檢視完整內容。

**Acceptance Scenarios**:

1. **Given** 管理員已登入, **When** 瀏覽首頁, **Then** 可看到所有課程列表，包含「草稿」「預購中」「熱賣中」三種狀態的課程
2. **Given** 管理員在首頁看到草稿課程, **When** 觀察課程卡片, **Then** 草稿課程顯示明顯的「草稿」標籤以資區別
3. **Given** 管理員在首頁點擊草稿課程, **When** 進入課程販售頁, **Then** 顯示完整課程內容，頁面頂部顯示「預覽模式」提示
4. **Given** 一般會員已登入, **When** 瀏覽首頁, **Then** 只能看到「預購中」和「熱賣中」狀態的課程，看不到草稿
5. **Given** 一般會員嘗試直接輸入草稿課程 URL, **When** 頁面載入, **Then** 顯示 404 頁面或「課程不存在」訊息
6. **Given** 管理員在草稿課程販售頁, **When** 檢視購買區塊, **Then** 顯示購買按鈕但附註「草稿課程，僅供預覽」
7. **Given** 管理員使用手機瀏覽, **When** 查看首頁草稿課程, **Then** 「草稿」標籤在手機版正確顯示且不影響排版

---

### User Story 9 - 課程顯示/隱藏設定 (Priority: P2)

管理員可為每個課程設定「是否顯示」開關。當設為「否」（隱藏）時，課程不會出現在首頁課程列表中，但用戶仍可透過直接訪問課程網址來查看和購買該課程。購買後，該課程正常顯示在學員的「我的課程」頁面中。此功能適用於限定會員、私人課程、或不希望公開宣傳但仍可購買的特殊課程。

**Why this priority**: 此功能提供靈活的課程曝光控制，適用於私人課程、限定優惠等特殊銷售場景，是行銷策略的重要工具。

**Independent Test**: 管理員將課程設為隱藏後，該課程從首頁消失，但透過直接 URL 可存取；購買後出現在「我的課程」。

**Acceptance Scenarios**:

1. **Given** 管理員在後臺編輯課程, **When** 觀察課程設定表單, **Then** 可看到「是否顯示」開關（預設為開啟/顯示）
2. **Given** 管理員將某課程設為「不顯示」, **When** 儲存設定, **Then** 儲存成功，課程的顯示狀態更新為隱藏
3. **Given** 課程設為「不顯示」且狀態為熱賣中, **When** 一般用戶瀏覽首頁, **Then** 該課程不出現在首頁課程列表中
4. **Given** 課程設為「不顯示」且狀態為熱賣中, **When** 一般用戶直接訪問課程販售頁 URL, **Then** 可正常查看課程內容和購買資訊
5. **Given** 課程設為「不顯示」, **When** 用戶透過直接 URL 完成購買, **Then** 購買流程與顯示課程完全相同
6. **Given** 用戶已購買隱藏課程, **When** 進入「我的課程」頁面, **Then** 該課程正常顯示在已購買課程列表中
7. **Given** 用戶已購買隱藏課程, **When** 點擊進入上課頁面, **Then** 可正常上課，功能與顯示課程完全相同
8. **Given** 管理員已登入, **When** 瀏覽首頁, **Then** 可看到所有課程（含隱藏課程），隱藏課程有「隱藏」標籤
9. **Given** 管理員在後臺課程列表, **When** 觀察課程列表, **Then** 可看到每個課程的顯示狀態（顯示/隱藏）

---

### Edge Cases

- 會員嘗試進入未購買課程的上課頁面時，顯示「您尚未購買此課程」並引導至課程販售頁
- 課程下架為草稿後，已購買會員仍可進入上課頁面（僅前台販售頁不可見）
- 課程章節為空（無任何小節）時，上課頁面顯示「課程內容準備中」
- Vimeo/YouTube 影片連結格式錯誤時，顯示驗證錯誤訊息
- 相簿上傳的圖片超過大小限制（10MB）時，顯示錯誤訊息
- 管理員刪除已有購買紀錄的課程時，提示「此課程已有學員購買，無法刪除」
- 預購課程的開賣時間設定為過去時間時，顯示驗證錯誤
- 會員網路斷線時，影片播放中斷，重連後可繼續播放
- 優惠到期時間設定為過去時間時，顯示驗證錯誤或自動視為無優惠
- 優惠價高於或等於原價時，顯示驗證警告「優惠價應低於原價」
- 僅設定原價而無優惠價時，課程顯示原價（無優惠效果）
- 相簿 Modal 中刪除圖片後，若該圖片已被插入介紹內容，不影響已插入的 HTML（圖片連結仍有效直到檔案被刪除）
- 插入圖片時輸入的尺寸為 0 或負數時，忽略該尺寸設定
- 法律政策 Modal 內容過長時，Modal 內部可滾動，但外部頁面不可滾動
- 用戶按下 ESC 鍵時，應關閉已開啟的法律政策 Modal
- 會員在 2 分鐘計時中網路斷線時，若計時器到期但無法送出請求，應在網路恢復後重試寫入完成紀錄
- 會員快速來回點擊同一個小節（如：點擊 A → 點擊 B → 點擊 A）時，計時器應重新開始計算
- 會員在小節 A 停留 1 分 59 秒後關閉瀏覽器分頁，小節 A 不應被記錄為完成
- 會員重新進入頁面時，應從伺服器載入真實的完成狀態（非前端樂觀更新的暫存狀態）
- 若小節已在伺服器記錄為完成，再次點擊該小節時不應重複發送完成請求
- 管理員建立課程時若發生錯誤（課程建立失敗），不應建立購買紀錄
- 管理員刪除課程時，自動指派的購買紀錄應一併移除（軟刪除）
- 管理員自動獲得的購買紀錄不應計入銷售統計
- 草稿課程的「購買按鈕」點擊時應顯示提示而非跳轉 Portaly（避免誤購）
- 當課程從草稿發佈為熱賣中時，管理員的預覽購買紀錄保持不變（仍可存取）
- 多位管理員同時存在時，每位管理員只自動獲得自己建立的課程擁有權
- 隱藏課程（is_visible=false）不應出現在首頁課程列表，但直接存取 URL 仍可購買
- 隱藏課程的販售頁功能應與顯示課程完全相同（購買、倒數計時等）
- 隱藏課程若同時為草稿狀態，草稿限制優先（一般用戶無法存取）
- 用戶已購買的隱藏課程應正常顯示在「我的課程」列表中
- 管理員在首頁應能看到隱藏課程，且有明顯「隱藏」標籤
- 管理員在後臺課程列表應能看到每個課程的顯示狀態

## Requirements *(mandatory)*

### Functional Requirements

**上課頁面：**
- **FR-001**: 系統 MUST 提供上課頁面 (/member/classroom/{courseId})，已購買會員可進入
- **FR-002**: 上課頁面 MUST 採用左右分欄佈局：左欄章節列表、右欄影片/內容區
- **FR-003**: 章節列表 MUST 顯示章標題、節標題、時間長度（如 3:50）
- **FR-004**: 會員點擊章節列表中的小節時，MUST 切換右側影片/內容
- **FR-005**: 系統 MUST 支援 Vimeo 和 YouTube 影片嵌入播放
- **FR-006**: 會員點擊小節時，MUST 立即在前端顯示綠色勾勾圖示（樂觀更新）
- **FR-006a**: 會員點擊已完成小節的勾勾圖示時，MUST 可將該小節恢復為未完成
- **FR-006b**: 完成紀錄 MUST 在小節停留滿 2 分鐘後才寫入伺服器
- **FR-006c**: 若會員在 2 分鐘內切換至其他小節，MUST 取消原小節的完成紀錄計時器
- **FR-006d**: 取消完成（點擊勾勾恢復未完成）MUST 立即發送至伺服器，不受 2 分鐘限制
- **FR-006e**: 會員離開頁面時，未達 2 分鐘門檻的小節 MUST NOT 記錄為完成
- **FR-007**: 小節如無影片，MUST 能顯示自定義 HTML 內容
- **FR-008**: 上課頁面 MUST 支援 RWD，手機版左欄可折疊

**管理員後臺：**
- **FR-009**: 系統 MUST 提供管理員後臺 (/admin)，僅 admin 角色可進入
- **FR-010**: 後臺 MUST 提供課程列表，顯示名稱、教師、狀態、優惠價、原價
- **FR-011**: 管理員 MUST 可新增課程，輸入名稱、教師名稱、時間總長（總分鐘數，前端自動換算為「X小時Y分鐘」顯示）、優惠價、原價、優惠到期時間
- **FR-011a**: 優惠到期時間 SHOULD 預設為建立日期後 30 天，管理員可修改或清除
- **FR-012**: 管理員 MUST 可編輯和刪除課程
- **FR-013**: 課程狀態 MUST 支援：草稿、預購中、熱賣中
- **FR-014**: 預購課程 MUST 可設定開賣時間，時間到自動切換為熱賣中
- **FR-015**: 管理員 MUST 可新增「章」和「節」，節可獨立存在（無章）
- **FR-016**: 小節 MUST 可設定 Vimeo/YouTube 連結或自定義 HTML 內容
- **FR-017**: 管理員 MUST 可調整章節排序（拖曳排序）
- **FR-018**: 管理員 MUST 可發佈課程，系統自動判斷狀態（有未來開賣時間 → 預購中，否則 → 熱賣中）
- **FR-018a**: 管理員 MUST 可將已發佈課程下架為草稿（預購中/熱賣中 → 草稿）
- **FR-019**: 課程介紹 MUST 支援自定義 HTML 編輯
- **FR-020**: 每個課程 MUST 有獨立相簿，可上傳、刪除圖片
- **FR-021**: 管理員 MUST 可將相簿圖片以自定義長寬插入介紹內容
- **FR-021a**: 插入圖片時 MUST 提供同頁相簿 Modal，可瀏覽、選擇、上傳圖片
- **FR-021b**: 相簿 Modal MUST 支援設定圖片寬度和高度，僅填一項時另一項自適應
- **FR-022**: 所有後臺頁面 MUST 支援 RWD

**課程販售頁：**
- **FR-023**: 優惠期間，販售頁 MUST 顯示兩個價格：原價（刪除線）+ 優惠價（醒目大字）
- **FR-024**: 優惠期間，販售頁 MUST 顯示倒數計時器
- **FR-025**: 倒數計時器 MUST 每秒即時更新，顯示格式為「優惠倒數 X 天 X 時 X 分 X 秒」
- **FR-025a**: 倒數計時器 MUST 採用深色背景卡片式設計，每個時間單位獨立顯示在圓角卡片內
- **FR-025b**: 倒數計時器數字變化時，MUST 以向下滾動動畫呈現（非直接替換）
- **FR-025c**: 倒數計時器 MUST 支援 RWD，在手機上保持可讀性
- **FR-026**: 優惠到期後，販售頁 MUST 僅顯示原價（無刪除線），隱藏優惠價和倒數計時
- **FR-027**: 若課程僅設優惠價（無原價、無到期時間），販售頁 MUST 僅顯示優惠價（無刪除線、無倒數計時）

**法律政策頁面：**
- **FR-028**: 系統 MUST 提供「服務條款」頁面，以 Modal 形式顯示
- **FR-029**: 系統 MUST 提供「購買須知」頁面，以 Modal 形式顯示
- **FR-030**: 系統 MUST 提供「隱私政策」頁面，以 Modal 形式顯示
- **FR-031**: 頁尾 MUST 包含三個法律政策頁面的連結
- **FR-032**: 點擊法律政策連結時，MUST 在當前頁面彈出 Modal，不導航至新頁面
- **FR-033**: 法律政策 Modal MUST 可透過關閉按鈕、點擊外部區域或按 ESC 鍵關閉
- **FR-034**: 購買須知 MUST 包含完整退款政策：
  - 「迷你課」和「講座」類型課程恕不退款
  - 大型課（「課程」類型）退款申請需在購買後 14 日內提出
  - 課程完成度超過 20% 恕不退款
- **FR-035**: 法律政策 Modal MUST 支援 RWD，手機版內容可滾動閱讀

**課程擁有權自動指派：**
- **FR-036**: 管理員新增課程時，系統 MUST 自動為該管理員建立購買紀錄
- **FR-037**: 自動建立的購買紀錄 MUST 標記為「系統指派」類型，金額為 $0
- **FR-038**: 自動建立的購買紀錄 SHOULD NOT 計入銷售統計和報表
- **FR-039**: 課程刪除時，對應的系統指派購買紀錄 MUST 一併移除

**管理員前端預覽：**
- **FR-040**: 管理員登入後，首頁 MUST 顯示所有課程（含草稿、預購中、熱賣中）
- **FR-041**: 首頁的草稿課程 MUST 顯示明顯的「草稿」狀態標籤
- **FR-042**: 管理員 MUST 可存取草稿課程的販售頁
- **FR-043**: 草稿課程販售頁 MUST 在頂部顯示「預覽模式」提示
- **FR-044**: 草稿課程的購買按鈕點擊時，MUST 顯示「草稿課程，僅供預覽」提示，不跳轉 Portaly
- **FR-045**: 一般會員 MUST NOT 在首頁看到草稿課程
- **FR-046**: 一般會員直接存取草稿課程 URL 時，MUST 顯示 404 或「課程不存在」
- **FR-047**: 所有管理員前端預覽功能 MUST 支援 RWD

**課程顯示/隱藏設定：**
- **FR-048**: 課程 MUST 有「是否顯示」設定欄位（is_visible），預設為顯示（true）
- **FR-049**: 管理員 MUST 可在後臺編輯課程時切換「是否顯示」開關
- **FR-050**: 隱藏課程（is_visible=false）MUST NOT 出現在首頁課程列表（對一般用戶）
- **FR-051**: 隱藏課程 MUST 可透過直接 URL 存取其販售頁
- **FR-052**: 隱藏課程的販售頁 MUST 提供完整購買功能（與顯示課程相同）
- **FR-053**: 用戶購買隱藏課程後，該課程 MUST 正常顯示在「我的課程」頁面
- **FR-054**: 用戶購買隱藏課程後，MUST 可正常進入上課頁面學習
- **FR-055**: 管理員在首頁 MUST 可看到隱藏課程，並顯示「隱藏」標籤
- **FR-056**: 後臺課程列表 MUST 顯示每個課程的顯示狀態
- **FR-057**: 若課程同時為草稿且隱藏，草稿限制 MUST 優先於隱藏設定（一般用戶無法存取）

### Key Entities

- **Chapter（章）**: 課程的大單元分類，包含標題、排序順序，一個課程可有多章
- **Lesson（節/小節）**: 實際課程內容單元，包含標題、影片連結（Vimeo/YouTube）或 HTML 內容、時間長度、排序順序、所屬章（可為空）
- **LessonProgress（學習進度）**: 會員點擊小節時新增一筆紀錄（會員 ID + 小節 ID），有紀錄即代表已完成
- **CourseImage（課程圖片）**: 課程相簿中的圖片，包含課程 ID、圖片路徑、檔案名稱、上傳時間、圖片原始寬高（供前端計算比例）
- **Course（課程）擴充**: 新增狀態欄位（草稿/預購中/熱賣中）、開賣時間、介紹 HTML 內容、時間總長（duration_minutes, 整數，單位：分鐘）、Portaly 商品 ID（portaly_product_id，字串，用於產生購買連結）、優惠價（price, 整數）、原價（original_price, 整數，可為空）、優惠到期時間（promo_ends_at, 日期時間，可為空）、是否顯示（is_visible, 布林值，預設 true）
- **Purchase（購買紀錄）擴充**: 新增購買類型欄位（type），支援「paid」（一般購買）、「system_assigned」（系統指派）、「gift」（贈送）；系統指派類型的紀錄不計入銷售統計

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 會員可在 3 秒內載入上課頁面並開始播放影片
- **SC-002**: 會員切換章節時，影片在 2 秒內開始播放
- **SC-003**: 會員點擊小節後，前端完成標記即時顯示（無延遲），實際寫入伺服器則需等待 2 分鐘
- **SC-003a**: 會員快速切換多個小節時（每個少於 2 分鐘），伺服器請求數應為 0（節流機制生效）
- **SC-003b**: 會員在某小節停留超過 2 分鐘後，完成紀錄應在 2 分鐘後 2 秒內寫入伺服器
- **SC-004**: 管理員可在 5 分鐘內完成一個課程的基本資料建立（含優惠價設定）
- **SC-005**: 管理員可在 10 分鐘內完成一個包含 3 章 10 節的課程結構編輯
- **SC-006**: 所有頁面在手機（320px 以上寬度）上完整顯示且可正常操作
- **SC-007**: 預購課程開賣時間到達後，1 分鐘內自動切換狀態
- **SC-008**: 倒數計時器在頁面上每秒即時更新，誤差不超過 1 秒
- **SC-008a**: 倒數計時器數字滾動動畫流暢，無卡頓或閃爍
- **SC-009**: 管理員可在 30 秒內完成「打開相簿 → 選擇圖片 → 設定尺寸 → 插入」的完整流程
- **SC-010**: 相簿 Modal 開啟時間不超過 1 秒（即使相簿有 50 張圖片）
- **SC-011**: 法律政策 Modal 在 0.5 秒內開啟並顯示內容
- **SC-012**: 用戶可在任意頁面存取法律政策 Modal，無需等待頁面載入
- **SC-013**: 管理員建立課程後，可在 5 秒內於「我的課程」看到該課程
- **SC-014**: 管理員在首頁可正確區分草稿和已發佈課程（草稿標籤清晰可見）
- **SC-015**: 管理員從建立課程到前端預覽的完整流程可在 2 分鐘內完成
- **SC-016**: 隱藏課程透過直接 URL 存取時，頁面載入時間與顯示課程相同（3 秒內）
- **SC-017**: 管理員可在 5 秒內完成課程顯示/隱藏狀態的切換

## Clarifications

### Session 2026-01-17

- Q: 小節「完成」的判定標準？ → A: 會員點擊該小節即視為完成（無需追蹤播放進度）
- Q: 預購課程開賣時間的自動切換機制？ → A: 使用排程任務每分鐘檢查
- Q: 相簿圖片大小限制？ → A: 單張圖片最大 10MB
- Q: 課程下架為草稿後，已購買會員能否上課？ → A: 已購買會員仍可上課（僅前台不可購買）
- Q: 發佈課程時如何決定「預購中」或「熱賣中」？ → A: 自動判斷（有未來開賣時間 → 預購中，否則 → 熱賣中）
- Q: 課程「時間總長」的資料格式？ → A: 數字格式（總分鐘數），例如 190，前端自動換算顯示為「3小時10分鐘」
- Q: Portaly 整合需要哪些欄位？ → A: 只需一個欄位 `portaly_product_id`，Product ID 可從 URL 提取（如 `https://portaly.cc/kyontw/product/LaHt56zWV8VlHbMnXbvQ` 中的 `LaHt56zWV8VlHbMnXbvQ`），完整 URL 可由系統根據 Product ID 動態產生

### Session 2026-01-17 (Update - 優惠價與同頁插圖)

- Q: 優惠價與原價的命名？ → A: 現有 `price` 欄位重新定義為「優惠價」（實際售價），新增 `original_price` 為「原價」
- Q: 優惠到期時間的預設值？ → A: 建立課程時預設 30 天後，管理員可自行修改或清除
- Q: 優惠到期後價格如何切換？ → A: 前端即時判斷，到期後顯示原價；若無原價則持續顯示優惠價
- Q: 倒數計時更新頻率？ → A: 每秒更新一次，顯示格式為「優惠剩餘 X 天 HH:MM:SS」以製造緊迫感
- Q: 相簿 Modal 的圖片載入方式？ → A: 使用縮圖列表，點擊後可放大預覽
- Q: 插入圖片的尺寸單位？ → A: 像素（px），產生的 HTML 使用 width/height 屬性
- Q: 價格顯示邏輯的具體樣式？ → A: 優惠期間顯示兩個價格：原價（刪除線）+ 優惠價（醒目大字）；優惠到期後僅顯示原價（無刪除線、無優惠價）
- Q: 價格區塊的顯示位置？ → A: 在課程販售頁的講師名稱和時間長度右側，使用醒目的漸層背景區塊（indigo-purple）
- Q: 優惠到期後的實際售價來源？ → A: 前端顯示邏輯獨立，Portaly 價格需管理員手動同步（本系統不自動更新 Portaly 售價）

### Session 2026-01-17 (Update - 法律政策頁面)

- Q: 法律政策內容的維護方式？ → A: 內容為靜態 HTML，直接寫在前端元件中，未來如需後台編輯可另行擴充
- Q: 退款政策中的「課程完成度」如何計算？ → A: 已完成小節數 / 總小節數 × 100%
- Q: 退款政策中的「14 日」計算起點？ → A: 從購買付款完成時間起算
- Q: 法律政策是否需要版本控制？ → A: 本階段不需要，內容變更直接更新前端程式碼

### Session 2026-01-18 (Update - 課程完成狀態節流機制)

- Q: 為什麼需要節流機制？ → A: 避免會員頻繁點選章節時產生過多伺服器請求，減輕伺服器負載
- Q: ~~5 分鐘~~ 2 分鐘門檻的設計考量？ → A: 確保會員實際閱讀/觀看過內容，而非僅快速瀏覽點擊（2026-01-30 調整：從 5 分鐘縮短為 2 分鐘，以提升用戶體驗）
- Q: 前端樂觀更新的用意？ → A: 提供即時視覺回饋，提升用戶體驗；即使未達 2 分鐘，用戶仍能看到「進度」
- Q: 取消完成為何不受 2 分鐘限制？ → A: 取消完成是用戶主動操作，應立即反映至伺服器以保持資料一致性
- Q: 計時器在前端還是後端實作？ → A: 純前端實作，使用 JavaScript setTimeout，伺服器不參與計時

### Session 2026-01-26 (Update - 課程擁有權自動指派與管理員預覽)

- Q: 自動指派的購買紀錄應如何標記？ → A: 新增購買類型欄位（type），值為「system_assigned」，金額為 $0
- Q: 自動指派的購買紀錄是否計入銷售？ → A: 不計入銷售統計和報表
- Q: 管理員 A 建立的課程，管理員 B 是否也自動擁有？ → A: 否，只有建立者自動獲得擁有權
- Q: 草稿課程在首頁如何顯示？ → A: 顯示在課程列表中，但有明顯「草稿」標籤
- Q: 一般會員能否看到草稿課程？ → A: 不能，首頁和販售頁都不可見
- Q: 草稿課程的購買按鈕是否可用？ → A: 可見但點擊後顯示提示，不跳轉 Portaly
- Q: 此功能的用途？ → A: 方便管理員在正式上架前，以用戶視角在前端完整檢查課程內容

### Session 2026-01-30 (Update - 課程顯示/隱藏設定)

- Q: 「是否顯示」功能的使用場景？ → A: 適用於私人課程、限定會員優惠、測試課程等不希望公開但仍可購買的情況
- Q: 隱藏課程是否影響購買功能？ → A: 不影響，透過直接 URL 存取時購買功能完全正常
- Q: 已購買的隱藏課程如何處理？ → A: 正常顯示在「我的課程」頁面，上課功能完全正常
- Q: 隱藏課程與草稿課程有何區別？ → A: 草稿課程一般用戶完全無法存取；隱藏課程只是不在首頁列表顯示，但可透過 URL 存取和購買
- Q: 是否顯示的預設值？ → A: 預設為顯示（is_visible=true）
- Q: 管理員如何識別隱藏課程？ → A: 首頁顯示「隱藏」標籤，後臺課程列表顯示顯示狀態欄位

## Assumptions

- Vimeo 和 YouTube 影片嵌入使用官方 embed iframe，不需處理播放器自定義
- 管理員數量有限（< 10 人），後臺不需考慮高併發
- 小節完成狀態採用前端節流機制：點擊後前端立即顯示勾勾，但需停留滿 2 分鐘才寫入伺服器
- 節流計時器為純前端實作，伺服器不參與計時邏輯
- 用戶離開頁面時，未達 2 分鐘門檻的進度不會被記錄
- 取消完成操作立即發送至伺服器，不受節流限制
- 頁面重新載入時，從伺服器獲取真實完成狀態（非前端暫存）
- 課程刪除採軟刪除，保留歷史資料
- 圖片儲存使用本地 storage，未來可擴展至 S3
- 章節排序使用 sort_order 欄位，拖曳後更新排序值
- Portaly 整合：資料庫只儲存 Product ID（如 `LaHt56zWV8VlHbMnXbvQ`），前端動態組合完整 URL `https://portaly.cc/kyontw/product/{product_id}`
- 優惠價定價模式：`price` 為實際售價（優惠價），`original_price` 為原價；若無原價則只顯示優惠價
- 倒數計時器為純前端實作，依據 `promo_ends_at` 計算剩餘時間
- 相簿 Modal 使用延遲載入（lazy load）優化大量圖片的載入效能
- Portaly 價格與本系統價格獨立管理：本系統僅控制前端顯示邏輯，Portaly 後台的實際售價需管理員手動同步更新
- 法律政策內容為靜態 HTML，不需要資料庫儲存或後台管理介面
- 法律政策 Modal 使用 Vue 3 Teleport 渲染至 body，確保 z-index 正確
- 退款流程不在本系統處理，僅提供政策說明；實際退款需用戶聯繫客服
- 管理員建立課程時自動獲得擁有權，此購買紀錄標記為「system_assigned」類型
- 系統指派的購買紀錄在帳號設定的訂單紀錄中顯示為「系統指派」，金額 $0
- 草稿課程只有管理員可在前端看到，一般會員無法存取
- 草稿課程的「草稿」標籤樣式為灰色背景，與「預購中」（黃色）和「熱賣中」（綠色）區別
- 草稿課程販售頁的「預覽模式」提示使用藍色背景的固定橫幅，位於頁面頂部
- 管理員預覽功能僅影響前端顯示邏輯，不影響現有 API 和後台功能
- 「是否顯示」設定僅影響首頁課程列表的顯示邏輯，不影響課程的其他功能
- 隱藏課程的 URL 結構與顯示課程相同，方便分享給特定用戶
- 課程的顯示/隱藏狀態與發佈狀態（草稿/預購中/熱賣中）互相獨立
- 當課程同時為草稿且隱藏時，草稿限制優先（一般用戶無法存取，即使有 URL）
- 「隱藏」標籤樣式採用灰色斜體文字，與「草稿」標籤（灰色背景）視覺上區分
